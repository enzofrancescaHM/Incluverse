<html>

<head>
  <script>
    // WebXR requires https: to work so ensure redirected if needed.
    if (location.hostname !== 'localhost' && window.location.protocol === 'http:') window.location.protocol = 'https:';
  </script>

  <!-- the AFrame library and 3rd party components -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.1/dist/aframe-master.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@fb96ab2/dist/components/sphere-collider.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@fb96ab2/dist/aframe-extras.controls.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/physx@v0.1.0/dist/physx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-blink-controls@0.4.3/dist/aframe-blink-controls.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/handy-work@3.1.10/build/handy-controls.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/handy-work@3.1.10/build/magnet-helpers.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-htmlmesh@2.0.1/build/aframe-html.min.js"></script>
  <script src="./js/ar-shadow-helper.js"></script>
  <script src="./js/ar-cursor.js"></script>
  <script src="./js/simple-navmesh-constraint.js"></script>
  <script src="./js/model-utils.js"></script>
  <script src="../dist/socketio_client_4.5.3.min.js"></script>
  <script src="../dist/networked-aframe.min.js"></script>
  <script src="../dist/mediasoup-adapter.js"></script>
  <script src="../dist/mediasoupclient.min.js"></script>
  <script>
    console.log('mediasoup-client-version', mediasoupClient.version);
  </script>
  
  <!-- Our custom behaviour -->
	<script src="./js/mybehave.js"></script>
  <script src="./js/ministart.js"></script>
  <script src="./js/play-on-click.js"></script>
  <script src="./js/cursor-listener.js"></script>

  <script src="./js/hide-when-sleeping.js"></script>
  <script src="./js/player-info.js"></script>
  <script src="./js/spawn-in-circle.js"></script>
  <script src="./js/autorotate.js"></script>
  <script src="./js/animation-mixer.js"></script>



  
  <title>Includia Metaverse</title>
  <meta property="og:title" content="Includia Metaverse Demo Scene" />
  <meta name="description" content="A sample scene for working with WebXR Hand Tracking" />
  <meta property="og:description" content="A sample scene for working with WebXR Hand Tracking" />
  <link rel="apple-touch-icon" sizes="57x57" href="/examples/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/examples/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/examples/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/examples/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/examples/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/examples/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/examples/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/examples/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/examples/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/examples/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/examples/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/examples/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/examples/icons/favicon-16x16.png">
  <link rel="manifest" href="/examples/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/examples/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <link rel="stylesheet" href="./css/style.css">
</head>

<body>
    <div class="mainUI" id="uiDiv" oncontextmenu="return false;">
        <!-- centered -->
        <div class="regionUI">
          <div class="buttonUI">
            <img src="images/enter.png" id="buttonEnter" />
          </div>
        </div>
      </div>
	<a-scene id="mainscene" ministart
    physx="autoLoad: true; delay: 1000; wasmUrl: https://cdn.jsdelivr.net/gh/c-frame/physx@v0.1.0/wasm/physx.release.wasm; useDefaultScene: false;"
		webxr="overlayElement:#dom-overlay;"
		background="color:skyblue;"
		reflection="directionalLight:#dirlight;"
		ar-hit-test="target:#my-ar-objects;type:footprint;footprintDepth:0.2;"
		shadow="type: pcf"
		gltf-model="dracoDecoderPath: https://cdn.jsdelivr.net/npm/three@0.129.0/examples/js/libs/draco/gltf/;" 
    cursor="rayOrigin:mouse"
	>
  <!-- if we want to enable touching with gaze put the following lines to scene declaration above -->
  <!-- ar-cursor raycaster="objects: #my-ar-objects a-sphere" -->

    <a-assets>
      <!-- <a-asset-item id="building-glb" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/venue.glb?v=1644331843500"></a-asset-item>
      <a-asset-item id="navmesh-glb" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/navmesh.glb?v=1644329586500"></a-asset-item>
      <a-asset-item id="right-gltf" src="https://vazxmixjsiawhamofees.supabase.co/storage/v1/object/public/models/skeleton-right-hand-webxr/model.gltf"></a-asset-item>
      <a-asset-item id="left-gltf" src="https://vazxmixjsiawhamofees.supabase.co/storage/v1/object/public/models/skeleton-left-hand-webxr/model.gltf"></a-asset-item>
      <a-asset-item id="watch-gltf" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/watch.glb?v=1645016979219"></a-asset-item>
      <a-asset-item id="sword-gltf" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/katana.glb?v=1648465043810"></a-asset-item>
      <a-asset-item id="watergun-gltf" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/watergun.glb?v=1646916260646"></a-asset-item>
      <a-asset-item id="stew-gltf" src="https://market-assets.fra1.cdn.digitaloceanspaces.com/market-assets/models/pot-stew/model.gltf"></a-asset-item>
      <a-asset-item id="table-gltf" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/small_wooden_table_01_1k-v1.glb?v=1647263187998"></a-asset-item>
      <a-asset-item id="clock-gltf" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/vintage_grandfather_clock_01_1k-v2.glb?v=1647265174189"></a-asset-item>
      <a-asset-item id="ladder-gltf" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/ladder.glb?v=1648465045608"></a-asset-item>
      <img id="bake" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/Bake(3).webp?v=1644331344700" crossorigin="anonymous">
      <a-mixin id="animations" animation__click="property: components.material.material.color; type: color; to: blue; startEvents: click; dur: 500;"></a-mixin>
      <a-mixin id="blink" blink-controls="rotateOnTeleport:false;cameraRig: #cameraRig; teleportOrigin: #head; collisionEntities:.navmesh;"></a-mixin>
      <a-mixin id="handle-visual" geometry="width:0.05;height:0.05;depth:0.2"></a-mixin> -->
    </a-assets>

    <!-- Avatar -->
    <template id="avatar-template">
        <a-entity class="avatar" player-info>
          <a-plane color="#FFF" width="3" height="2" position="0 3.5 1" material="side: back"
            hide-when-sleeping
            >
          </a-plane>
          <a-plane color="#FFF" width="3" height="2" position="0 1.5 1" material="side: back; shader: flat"
            networked-video-source="streamName: video"
            hide-when-sleeping>
          </a-plane>
          <a-plane color="#FFF" width="3" height="2" rotation="0 0 0" position="0 5 0" material="side: front"
            networked-audio-source="streamName: audio"
            hide-when-sleeping>
          </a-plane>
          <a-entity gltf-model="#enzoavatar" scale="5 5 5" position="0 -3.2 0" rotation="0 180 0" shadow="cast:true; receive: true"></a-entity>
          <!-- here we add a text component for a nametag; the value will be updated by the player-info component -->
          <a-text class="nametag" value="MR.Avatar" rotation="0 180 0" position=".25 -1.50 0" side="double" scale=".7 .7 .7"></a-text>

        <!--   <a-sphere class="head" scale="0.45 0.5 0.4"></a-sphere>
          <a-entity class="face" position="0 0.05 0">
            <a-sphere class="eye" color="#efefef" position="0.16 0.1 -0.35" scale="0.12 0.12 0.12">
              <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2"></a-sphere>
            </a-sphere>
            <a-sphere class="eye" color="#efefef" position="-0.16 0.1 -0.35" scale="0.12 0.12 0.12">
              <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2"></a-sphere>
            </a-sphere>
          </a-entity> -->
        </a-entity>
      </template>

      <template id="emptyavatar">
        <a-entity class="avatar">
         
          </a-plane>
          </a-entity>
      </template>


      <template id="teachplace-template">
        <a-entity class="teach">
          <a-plane color="#FFF" width="9" height="5" position="-9 4.7 14.9" scale="-1 1 1" material="side: back; shader:flat"
          networked-video-source="streamName: screenshare"
          >
          </a-plane>
          </a-entity>
      </template>


      <a-entity id="dirlight" 
                rotation="21 0.4 0.1"
                position="-0.64 8.7 10.5"
                scale="0.1 0.1 0.1"
                
                light="intensity: 1.5; castShadow: true; shadowCameraTop: 10.9; shadowCameraRight: 17.18; shadowCameraBottom: -10.82; shadowCameraLeft: -17.76">
      </a-entity>


    <a-entity
      id="cameraRig"
      spawn-in-circle="radius:5"
      networked="template:#emptyavatar;attachTemplateToLocal:false"
      simple-navmesh-constraint="navmesh:.navmesh;fall:0.5;height:0;exclude:.navmesh-hole;"
      movement-controls="speed:0.3;camera:#head;"
      position="-1 0 1" rotation="0 45 0" origin-on-ar-start
    >
      <!-- camera -->
      <a-entity id="head"
      networked="template:#avatar-template;attachTemplateToLocal:true"
        camera="near:0.01;"
        look-controls="pointerLockEnabled: false"
        position="0 4.0 0"
        visible = false
      >
      <a-entity cursor="fuse: false; fuseTimeout: 500"
        position="0 0 -1"
        geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
        material="color: black; shader: flat"
        visible="false">
      </a-entity>
    </a-entity>
      
      <a-entity xr-follow>
        <a-gltf-model
          id="sword" src="#sword-gltf" shadow="receive:false;"
          data-pick-up class="magnet-left magnet-right"
          position="-0.2 -0.4 0" rotation="-30 180 0" scale="0.6,0.6,1"
          animation__restore_position="startEvents:putdown;pauseEvents:pickup;property:position;to:-0.2 -0.4 0;easing:easeOutBack;"
          animation__restore_rotation="startEvents:putdown;pauseEvents:pickup;property:rotation;to:-30 180 0;easing:easeOutBack;"
        >
          <a-box physx-body="type: kinematic;" width="0.03" height="0.03" depth="0.790" rotation="-16 0 0" position="0 -0.062 -0.331" visible="false"></a-box>
        </a-gltf-model>
        <a-gltf-model 
          shadow="receive:false;" id="watergun" src="#watergun-gltf"
          physx-body-from-model="type: kinematic;"
          class="magnet-left magnet-right" data-pick-up 
          position="0.2 -0.4 0" rotation="30 180 0"
          linear-constraint="axis:0 1 0;min:-0.15;max:0;part:Slider;"
          animation__restore_position="startEvents:putdown;pauseEvents:pickup;property:position;to:0.2 -0.4 0;easing:easeOutBack;"
          animation__restore_rotation="startEvents:putdown;pauseEvents:pickup;property:rotation;to:30 180 0;easing:easeOutBack;"
        >
          <a-entity id="watergun-slider-magnet" rotation="-74 0 0" attach-to-model="Slider"></a-entity>
        </a-gltf-model>
      </a-entity>
      
      <!-- Hand tracking -->
      <a-entity handy-controls="right:#right-gltf;materialOverride:right;" material="color:gold;metalness:1;roughness:0;">
        
        <!-- For screen space inputs like mobile AR -->
        <a-torus radius="0.008" radius-tubular="0.001" material="shader:flat;color:blue" data-none="screen-0"></a-torus>
        <a-torus radius="0.008" radius-tubular="0.001" material="shader:flat;color:green" data-none="screen-1"></a-torus>
        <a-torus radius="0.008" radius-tubular="0.001" material="shader:flat;color:red" data-none="screen-2"></a-torus>
        
        <!-- Put an exit button on the wrist for handtracking -->
        <a-gltf-model src="#watch-gltf" data-left="wrist" position="-1000 0 0">
          <a-sphere radius="0.02" position="0 0.02 0" sphere-collider="radius:0.02;objects:[data-right$=-tip];" exit-on="hitend" visible="false"></a-sphere>
        </a-gltf-model>
        
        <!-- Add a golden ring on the finger -->
        <a-entity data-left="ring-finger-phalanx-proximal">
          <a-torus position="0 0 -0.03" radius="0.008" radius-tubular="0.001" scale="1 1 1.5" material="color:gold;metalness:1;roughness:0;"></a-torus>
        </a-entity>
        
        <!-- Use the finger tips for teleporting when the user points -->
        <a-entity data-right="index-finger-tip" mixin="blink" blink-controls="snapTurn:false;startEvents:pose_point_fuseShort;endEvents:pose_point_fuseLong;cancelEvents:pose_cancel_point;"></a-entity>
        <a-entity data-left="index-finger-tip"  mixin="blink" blink-controls="snapTurn:false;startEvents:pose_point_fuseShort;endEvents:pose_point_fuseLong;cancelEvents:pose_cancel_point;"></a-entity>

        <!-- The direction hands are facing, we will also attach labels to show the currently detected pose or controller button -->
        <!-- These also do teleportaion for Blink controls in VR -->
        <a-entity data-right="ray" mixin="blink" cursor="" raycaster="objects:[html];far:0.3;showLine:false;lineColor:black;">
          <a-entity position="0 0 -0.22" visible="false" class="pose-label" text="value: Hello World; align: center;"></a-entity>
        </a-entity>
        <a-entity data-left="ray" mixin="blink" cursor="" raycaster="objects:[html];far:0.3;showLine:false;lineColor:black;">
          <a-entity position="0 0 -0.22" visible="false" class="pose-label" text="value: Hello World; align: center;"></a-entity>
        </a-entity>
        
        <!-- These get drawn towards grabable objects, moving the whole hand and the attached elements-->
        <a-entity id="left-magnet" data-left="grip"  data-magnet="magnet-left"  grab-magnet-target="startEvents:squeezestart,pose_fist;stopEvents:pose_flat_fuseShort,squeezeend;noMagnetEl:#left-no-magnet;"></a-entity>
        <a-entity id="right-magnet" data-right="grip" data-magnet="magnet-right" grab-magnet-target="startEvents:squeezestart,pose_fist;stopEvents:pose_flat_fuseShort,squeezeend;noMagnetEl:#right-no-magnet;"></a-entity>
    
        <!-- markers to let us know the real location of the hands, you probably want to make them visible="false" or just make them empty <a-entities> -->
        <a-entity id="left-no-magnet" data-left="grip" data-no-magnet>
          <a-entity html="html:#my-interface;cursor:#cursor" position="-0.142 -0.0166 -0.02928" rotation="-80 90 0" scale="0.7 0.7 0.7"></a-entity>
        </a-entity>
        <a-entity id="right-no-magnet" data-right="grip" data-no-magnet></a-entity>
        
        <!-- Invisible objects at the tips of each finger for physics or intersections -->
        <a-sphere data-right="index-finger-tip" radius="0.004" visible="false" physx-body="type: kinematic;"></a-sphere>
        <a-sphere data-right="middle-finger-tip" radius="0.004" visible="false" physx-body="type: kinematic;"></a-sphere>
        <a-sphere data-right="ring-finger-tip" radius="0.004" visible="false" physx-body="type: kinematic;"></a-sphere>
        <a-sphere data-right="pinky-finger-tip" radius="0.004" visible="false" physx-body="type: kinematic;"></a-sphere>
        <a-sphere data-right="thumb-tip" radius="0.004" visible="false" physx-body="type: kinematic;"></a-sphere>
        <a-sphere data-left="index-finger-tip" radius="0.004" visible="false" physx-body="type: kinematic;"></a-sphere>
        <a-sphere data-left="middle-finger-tip" radius="0.004" visible="false" physx-body="type: kinematic;"></a-sphere>
        <a-sphere data-left="ring-finger-tip" radius="0.004" visible="false" physx-body="type: kinematic;"></a-sphere>
        <a-sphere data-left="pinky-finger-tip" radius="0.004" visible="false" physx-body="type: kinematic;"></a-sphere>
        <a-sphere data-left="thumb-tip" radius="0.004" visible="false" physx-body="type: kinematic;"></a-sphere>
      </a-entity>
    </a-entity>
    
  <!--   <a-entity id="my-ar-objects" position="-6 0 1">
      
      <a-gltf-model id="piano" rotation="0 100 0" shadow="receive:false;cast:true;" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/piano.glb?v=1644414775118">
        <a-plane rotation="-90 0 0" width="1.5" height="0.6" class="navmesh-hole" visible="false"></a-plane>
      </a-gltf-model>
    </a-entity> -->

    <!-- This plane is only visible in AR and follows the given target to provide it with shadows.-->
	<!-- 	<a-light id="dirlight" shadow-camera-automatic="[ar-shadow-helper],#table,#ladder" intensity="0.8" light="castShadow:true;type:directional" position="0 3 -6"></a-light>
    <a-entity ar-shadow-helper="target:#my-ar-objects;light:#dirlight;" visible="false">
      <a-plane rotation="-90 0 0" shadow="cast:false;receive:true;" position="0 0.01 0" material="shader:shadow; depthWrite:false; opacity:0.9;"></a-plane>
    </a-entity>

    <a-entity hide-on-enter-ar position="0 -0.2 0" environment="lighting:none;shadow:true;preset: osiris;"></a-entity>
		<a-entity rotation="0 -50 0" position="0 0 0" hide-on-enter-ar>
      <a-box 
        position="-5.148 -0.1 -0.355"
        visible="false"
        geometry="width:33.67;height:0.2;depth:19.06"
        physx-body="type: static;"
        physx-restitution="1.5">
      </a-box>
      <a-gltf-model id="pot" toggle-physics shadow="receive:false;" src="#stew-gltf" position="-2 1.2 0.8" physx-body-from-model="type:dynamic;mass:2;">
        <a-entity id="stew-handle-1" data-magnet-range="0.2,0.1,360,180" data-pick-up="parent" class="magnet-left magnet-right" position="0 0.35 -0.35" rotation="0 90 0"></a-entity>
        <a-entity id="stew-handle-2" data-magnet-range="0.2,0.1,360,180" data-pick-up="parent" class="magnet-left magnet-right" position="0 0.35 0.35" rotation="0 90 0"></a-entity>
      </a-gltf-model>
      <a-gltf-model id="table" shadow="receive:true;" src="#table-gltf" position="-2 0 0.8" rotation="0 51 0" scale="1.5 1.5 1.5" physx-body-from-model="type: static;">
        <a-plane rotation="-90 0 0" width="1.2" height="0.6" class="navmesh-hole" visible="false"></a-plane>
      </a-gltf-model>
      
     
      <a-box position="-1.657 0.893 0.421" width="0.2" height="0.2" depth="0.2" color="grey"
          animation__press="startEvents:press;property:components.material.material.color;type:color;to:green;dur:100;"
          animation__release="startEvents:release;property:components.material.material.color;type:color;to:grey;dur:100;"
      >
        <a-entity position="0 0.12 0" linear-constraint="target:[data-no-magnet];axis:0 1 0;min:0;max:0.18;radius:0.1;useFixedValueIfOutOfRange:true;valueIfOutOfRange:0.18;downEventName:press;downEventThreshold:0;upEventName:release;upEventThreshold:0.18;">
          <a-cylinder radius="0.09" height="0.2" position="0 -0.1 0" color="hotpink"></a-cylinder>
        </a-entity>
      </a-box> -->
  
    <!--   <a-gltf-model id="ladder" ladder="grabbables:#ladder-left-hand,#ladder-right-hand;cameraRig:#cameraRig;" shadow src="#ladder-gltf" position="-4.98177 -0.01925 -2.97802" rotation="-4.9623 -62.929 0.6165" physx-body-from-model="type: static;">
        <a-plane rotation="-90 0 0" width="1.2" height="0.6" class="navmesh-hole" visible="false"></a-plane>
        <a-entity position="-0.25 0.07 0" linear-constraint="target:#left-no-magnet;axis:0 1 0;min:0;max:2.4;step:0.2;">
          <a-entity id="ladder-left-hand" data-magnet-range="0.2,0.15,360,300" class="magnet-left" rotation="0 90 0" linear-constraint="target:#left-no-magnet;axis:1 0 0;max:0.5;"></a-entity>
        </a-entity>
        <a-entity position="-0.25 0.07 0" linear-constraint="target:#right-no-magnet;axis:0 1 0;max:2.5;step:0.2;">
          <a-entity id="ladder-right-hand" data-magnet-range="0.2,0.15,360,300" class="magnet-right" rotation="0 -90 0" linear-constraint="target:#right-no-magnet;axis:1 0 0;max:0.5;"></a-entity>
        </a-entity>
      </a-gltf-model> -->
      
   <!--    <a-gltf-model id="clock" shadow="receive:true;" src="#clock-gltf" position="-5 0 1.8" rotation="0 51 0" physx-body-from-model="type:dynamic;mass:15;"></a-gltf-model>
      <a-gltf-model class="navmesh" src="#navmesh-glb" visible="false"></a-gltf-model> -->
   <!--    <a-gltf-model src="#building-glb"
        id="building"
        lightmap="src:#bake;intensity: 1.5; filter:Window,Ceiling,floor;"
        depthwrite="true"
        window-replace="Glass"
        no-tonemapping="Light"
        shadow="cast:false;receive:true;"
      ></a-gltf-model> -->

    

    <!-- </a-entity> -->

    <a-assets>
        <a-asset-item id="enzoavatar" src="models/enzoavatar_nohands.glb"></a-asset-item>
        <a-asset-item id="maingallery" src="models/vr_gallery/scene.gltf"></a-asset-item>
        <a-asset-item id="navmesh-glf" src="models/vr_gallery/navmesh.gltf"></a-asset-item>
        <a-asset-item id="statue" src="models/the_discobolus_of_myron.glb"></a-asset-item>
        <a-asset-item id="playbutton" src="models/playbutton.glb"></a-asset-item>
        <img id="logo_includia" src="images/logo_includia.png">
        <img id="logo_holomask" src="images/logo_holomask.png">
        <video id="videoBunny" preload="none" src="https://cdn.aframe.io/videos/bunny.mp4" width="160" height="90"  loop="true" crossOrigin="anonymous" muted></video>
        <video id="videoFireworks" preload="none" src="https://cdn.aframe.io/videos/fireworks.mp4" width="160" height="90"  loop="true" crossOrigin="anonymous" muted></video>
        <video id="vid" poster="images/enter.png" crossOrigin="anonymous" type="video/mp4" src="video/SampleVideo.mp4" autoplay loop="true" playsinline webkit-playsinline controls />
    </a-assets>

    <a-entity gltf-model="#maingallery" scale="3 3 3" position="0 0.2 0" shadow="cast:false; receive: true"></a-entity>
    <a-entity id="centralobject" autorotate="speed:0" gltf-model="#statue" scale="2 2 2" position="0 2.57 0" shadow="cast:true; receive: false" animation-mixer></a-entity>
    <!-- <a-entity gltf-model="#enzoavatar" position="5 3 5"></a-entity> -->
    <a-entity id="cubelimiter" geometry="" position="0 5 0" scale="6 6 6" visible="false"></a-entity>

    <a-entity id="shadbox1" geometry="" scale="40 1 40"     material="opacity: 0.41; shader: shadow"  shadow="cast:false; receive: true"></a-entity>
    <a-entity id="shadbox2" position="0 2.052 0" geometry="" scale="3.34 1 3.33" material="opacity: 0.73; shader: shadow"  shadow="cast:false; receive: true"></a-entity>
    <a-entity id="shadbox3" position="0 1.908 0" geometry="" scale="4.04 1 4.04" material="shader: shadow; opacity: 0.73"  shadow="cast:false; receive: true"></a-entity>
    <a-entity geometry="" position="0 1.454 0" scale="4.04 1.89 4.04" shadow="cast:true; receive: true" id="fakecube"></a-entity>

    <!-- first panel video with button -->
    <a-box color="white" depth="1" height="4.8" width="8.2"  position="15.33 4.7 10" rotation="0 -90 0"></a-box>
    <a-entity material="shader: flat; src: #videoBunny" geometry="primitive: plane; width: 8; height: 4.5;" position="14.81 4.7 10" rotation="180 90 180"  visible="true">
    </a-entity>
    <a-entity cursor-listener="videoid:videoBunny" gltf-model="#playbutton"  position="14.84 0.95 10" rotation="-90 -90 0" scale="0.5 0.5 0.5"></a-entity>
    <a-text text="color: #86dafd; tabSize: 3.99; value: video 1" position="14.44 7.513 8.481" rotation="0 -90 0" scale="4 4 4"> </a-text>
    
    <!-- second panel video with button -->
    <a-box color="white" depth="1" height="4.8" width="8.2"  position="9.5 4.7 15.41" rotation="0 0 0"></a-box>
    <a-entity material="shader: flat; src: #videoFireworks" geometry="primitive: plane; width: 8; height: 4.5" position="9.5 4.7 14.9" rotation="180 0 180"  visible="true">
    </a-entity>
    <a-entity cursor-listener="videoid:videoFireworks" gltf-model="#playbutton"  position="9.5 0.95 14.9" rotation="-90 90 90" scale="0.5 0.5 0.5"></a-entity>
    <a-text text="color: #86dafd; tabSize: 3.99; value: video 2" position="10.57 7.513 14.905" rotation="0 180 0" scale="4 4 4"> </a-text>

    <!-- third panel video for teach mode -->
    <a-box color="white" material="" depth="1" height="5.8" width="9.2"  position="-9.0 4.7 15.41" rotation="0 0 0"></a-box>
    <a-entity  material="shader: flat" id="teach"
      networked="template:#teachplace-template;attachTemplateToLocal:true"
    >
    </a-entity>
    <a-text text="color: #86dafd; tabSize: 3.99; value: screenshare" position="-6.47 8.085 14.905" rotation="0 180 0" scale="4 4 4"> </a-text>

    <!-- Logos -->
    <a-image src="#logo_includia" material="" geometry="width: 2.3" rotation="180 90 180" position="14.9 4.7 0" scale="4 4 4"></a-image>    
    <a-image src="#logo_holomask" material="" geometry="width: 7.13" rotation="180 -90 180" position="-14.97848 4.7 0" scale="2 2 2"></a-image>
    
    <!-- Nav Mesh -->
    <a-entity nav-mesh class="navmesh" gltf-model="#navmesh-glf" position="0 0 0" visible="false"></a-entity>

    <!-- Interface GUI-->
    <div class="maincontrol">
      <div class="toolbar">

        <div class="toolbarbutton">
          <div id="containervideo" class="toolbarbuttoniconcontainer"  onClick="toggleStream(this, 'video')">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="m14.64 12.061 3.231 2.275a.625.625 0 0 0 .879-.572v-7.53a.625.625 0 0 0-.879-.57l-3.23 2.274a.625.625 0 0 0-.266.51v3.102a.624.624 0 0 0 .265.511Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M10.469 14.998H3.28a2.037 2.037 0 0 1-2.031-2.03V7.03a2.037 2.037 0 0 1 2.031-2.031h7.207A2.019 2.019 0 0 1 12.5 7.01v5.956a2.037 2.037 0 0 1-2.031 2.031Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10"></path></svg>
            <div id="indicatorvideo" class="toolbarstatusindicator"></div>
          </div>
          <label class="toolbarbuttonlabel">cam</label>
        </div>
        
        <div class="toolbarbutton">
          <div id="containeraudio" class="toolbarbuttoniconcontainer" onClick="toggleStream(this, 'audio')">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.5 17.5h5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><rect x="8" y="8" width="4" height="0" fill="#7ED320"></rect><path d="M15 8.126v1.25c0 2.75-2.25 5-5 5s-5-2.25-5-5v-1.25" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M10 14.376v3.125" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M10 2.5A2.487 2.487 0 0 0 7.5 5v4.336c0 1.375 1.133 2.54 2.5 2.54s2.5-1.133 2.5-2.54V5c0-1.406-1.094-2.5-2.5-2.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            <div id="indicatoraudio" class="toolbarstatusindicator"></div>
          </div>
          <label class="toolbarbuttonlabel">audio</label>
        </div>

        <div class="toolbarbutton">
          <div id="containerscreen" class="toolbarbuttoniconcontainer" onClick="toggleStream(this, 'screenshare')">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.545 4H2.555C1.863 4 1.3 4.562 1.3 5.255v8.114c0 .694.562 1.256 1.256 1.256h14.989c.693 0 1.255-.562 1.255-1.255V5.255C18.8 4.562 18.238 4 17.545 4Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"></path><path d="M5.05 16.502h10" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round"></path><path d="M12.697 9.325 10.123 6.75 7.55 9.325" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M10.123 11.415V6.752" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            <div id="indicatorscreen" class="toolbarstatusindicator"></div>
          </div>
          <label class="toolbarbuttonlabel">share</label>
        </div>

        <div class="toolbarbutton">
          <div class="toolbarbuttoninputcontainer">
            <input id="username-overlay"  class="inputname" oninput="document.getElementById('head').setAttribute('player-info', 'name', this.value)">
          </div>

          <label class="toolbarbuttonlabel">user name</label>
        </div>

        <div class="toolbarbutton">
          <div class="toolbarbuttoninputcontainer">
            <input id="modelpath"  class="inputname" onchange="loadExternalModel(this, this.value, 'user')">
          </div>

          <label class="toolbarbuttonlabel">load object</label>
        </div>

        <div class="toolbarbutton">
          <div id="containerscreen" class="toolbarbuttoniconcontainer" onClick="toggleSpin('neutral')">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle
                style="fill:#ffffff;stroke-width:17.6315;stroke-linecap:round;stroke-linejoin:round"
                id="path956"
                cx="10.09837"
                cy="10.275146"
                r="3.0273008" />
              <path style="fill:none;fill-rule:evenodd;stroke:#ffffff"
                    id="path1061"
                    d="M 5.2064458,9.612158 C 5.2807593,6.9724885 7.6866377,5.008244 10.259017,5.1234091 13.314325,5.2601947 15.574245,8.0580312 15.403575,11.046478 15.20535,14.5174 12.014448,17.073704 8.6100078,16.846845 4.7234726,16.58786 1.8703124,13.003161 2.1538323,9.1827799 2.4731057,4.8806262 6.4521108,1.7302754 10.688395,2.0707955 c 4.71778,0.3792238 8.165566,4.7529028 7.767793,9.4050605 -0.294181,3.440597 -2.594672,6.461861 -5.780982,7.756874" />
            </svg>
            <div id="indicatorspin" class="toolbarstatusindicator"></div>
          </div>
          <label class="toolbarbuttonlabel">spin</label>
        </div>

      </div>
    </div>

    <!-- <div class="control"> -->
      <!-- <button id="videoBtn" onClick="toggleStream(this, 'video')" disabled>enable webcam</button> -->
      <!-- <button id="shareBtn" onClick="toggleStream(this, 'screenshare')" disabled>enable screenshare</button> -->
      <!-- <button id="audioBtn" onClick="toggleStream(this, 'audio')" disabled>enable microphone</button> -->
      <!-- <button id="teachBtn" onClick="teachButton(this)" disabled>enable teach-mode</button>       -->
    <!-- </div> -->

   <!--  <div style="font-family: math; font-size:large; z-index: 100; bottom: 120px; left: 27px; position: fixed">
      Your name
    </div>
    <input id="username-overlay" style="z-index: 100; bottom: 97px; border-radius:6px; height: 24px;font-family: 'Lobster', sans-serif; font-size:large; left: 24px; position: fixed" oninput="document.getElementById('head').setAttribute('player-info', 'name', this.value)">
 -->
    <a-sphere color="black" radius="0.005" id="cursor" material="shader:flat" visible="false"></a-sphere>

    <a-entity light="type:ambient;intensity:0.5"></a-entity>

	</a-scene>

	<!-- <div id="dom-overlay">
    <h1>
      Hello World
    </h1>
		<div class="overlay-footer">
      <section style="display: inline-block; background: lavenderblush; color: #333333; border-radius: 1em; padding: 1em; margin:0; accent-color: hotpink;" id="my-interface">
        <h2>Settings</h2>
        <fieldset style="border:none;">
          <legend>Thumbstick Behaviour</legend>
          <input onclick="toggleThumbstick(this)" type="radio" id="thumbstick-teleport" name="thumbstick" value="teleport" checked><label for="thumbstick-teleport"> Teleport</label>
          <input onclick="toggleThumbstick(this)" type="radio" id="thumbstick-move" name="thumbstick" value="move"><label for="thumbstick-move"> Move</label>
        </fieldset>
        <button onclick="AFRAME.scenes[0].exitVR()" style="display: block;">Exit Immersive</button>
        <button onclick="AFRAME.scenes[0].exitVR()" style="display: block;">Start Sync</button>
        <img src="images/enter.png" id="buttonEnter" />
      </section>
      
    
      <script>
        let movementType = 'teleport';
        function toggleThumbstick(detail) {
          const rayPointers = ['[data-right="ray"]', '[data-left="ray"]'].map(s => document.querySelector(s));
          const type = detail.value;
          movementType = type;
          if (type === 'move') {
            cameraRig.setAttribute('movement-controls', 'enabled', true);
            for (const p of rayPointers) p.removeAttribute('mixin');
          }
          if (type === 'teleport') {
            cameraRig.setAttribute('movement-controls', 'enabled', false);
            for (const p of rayPointers) p.setAttribute('mixin', 'blink');
          }
        }
        // If the user is teleporting disable movement-controls in XR
        const sceneEl = document.querySelector("a-scene");
        sceneEl.addEventListener("enter-vr", function() {
          if (movementType === 'teleport') {
            cameraRig.setAttribute('movement-controls', 'enabled', false);
          }
        });
        sceneEl.addEventListener("exit-vr", function() {
          cameraRig.setAttribute('movement-controls', 'enabled', true);
        });
      </script>
      <div id="dom-overlay-message">Enter AR or VR to start.</div>
    </div>
	</div> -->
  
 <!--  <script>
    window.addEventListener('click', function () {
      var video = document.querySelector('#vid');
      if (video.paused == true) {
        video.play();
        } else {
        video.pause();
      }
    }, false);
   
  </script> -->
  <script>
    //document.querySelector('#sky').src = `https://cdn.pixabay.com/photo/2022/11/09/01/59/profile-7579739_1280.jpg?random=${+new Date()}`
    // Called by Networked-Aframe when connected to server
    function onConnect() {
      console.log('onConnect', new Date());
    }

    let webcamStream = null;
    let microphoneStream = null;
    let screenshareStream = null;

    // add templates to sync
    NAF.schemas.add({
      template: '#avatar-template',
      components: [
        'position',
        'rotation',
        'player-info'
       
      ]
    });

    NAF.schemas.add({
      template: '#teachplace-template',
      components: [
        'position',
        'rotation',
        {
          selector: '.teach',
          component: 'material',
          property: 'color'
        }
      ]
    });

    NAF.connection.subscribeToDataChannel('test', receivedMessage);

    function receivedMessage(sender, channel, data){
      console.log(sender, channel, data);
      if (channel == "test" && data == "spinon")
        toggleSpin("SPINON");
      if (channel == "test" && data == "spinoff")
        toggleSpin("SPINOFF");
      if(channel == "test" && data.includes("modelload"))
      {
        var array = data.split(',');
        loadExternalModel("",array[1],"aswefw");
      }
      
    }

    async function teachButton(target){
      if (target.textContent.includes('enable')) 
      {
        // this is the case of enabling teach mode
        // we have to move the share screen plane 
        // to the right position on a wall

        target.textContent = `disable teach-mode`;
      }
      else
      {
        // this is the case of disabling teach mode
        // we have to move the share screen plane 
        // back to the right position on the avatar

        target.textContent = `enable teach-mode`;
      }
    }



    async function loadExternalModel(target, modelpath, mode){
      console.log("we are in the load model");
      //console.log(target.value);

      if(mode == "user")
        NAF.connection.broadcastData('test', 'modelload,' + modelpath); 

      document.getElementById('centralobject').setAttribute('gltf-model', modelpath)
    }

    async function toggleSpin(command){
        // check the GUI in order to understand if we must enable or disable items
        let isEnabled = false;
        let mytarget = document.getElementById("indicatorspin");
        let centralObject = document.querySelector('#centralobject');
        
        if(mytarget.classList.contains("toolbarstatusindicatoron"))  
          isEnabled = true;
        
        if(command == "SPINON")
          isEnabled = false;

        if(command == "SPINOFF")
          isEnabled = true;
        

        if(isEnabled){
          centralObject.setAttribute('autorotate', 'speed', 0.000);
          mytarget.classList.remove("toolbarstatusindicatoron");
          if(command == "neutral")
            NAF.connection.broadcastData('test', 'spinoff'); // send the command to everyone to stop spin the object
                
        }
        else{
          centralObject.setAttribute('autorotate', 'speed', 0.005);
          mytarget.classList.add("toolbarstatusindicatoron");
          if(command == "neutral")
            NAF.connection.broadcastData('test', 'spinon'); // send the command to everyone to spin the object
        }
        
    }

    async function toggleStream(target, type) {


      // check the GUI in order to understand if we must enable or disable items
      let isEnabled = false;
      console.log(target.id);
      if(target.id == "containervideo"){
        if(document.getElementById("indicatorvideo").classList.contains("toolbarstatusindicatoron"))  
          isEnabled = true;
      }
      if(target.id == "containeraudio"){
        if(document.getElementById("indicatoraudio").classList.contains("toolbarstatusindicatoron"))  
          isEnabled = true;
      }
      if(target.id == "containerscreen"){
        if(document.getElementById("indicatorscreen").classList.contains("toolbarstatusindicatoron"))  
          isEnabled = true;
      }


      let stream = type === 'video' ? webcamStream : type === 'audio' ? microphoneStream : screenshareStream
      console.log(stream);
      if (isEnabled == false) {
        try {
          // enable/resume stream
          if (!stream) {
            // first time
            switch (type) {
              case 'video':
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                await NAF.connection.adapter.addLocalMediaStream(webcamStream, type)
                break;
              case 'audio':
                microphoneStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true })
                await NAF.connection.adapter.addLocalMediaStream(microphoneStream, type)
                break;
              case 'screenshare':
                screenshareStream = await navigator.mediaDevices.getDisplayMedia()
                await NAF.connection.adapter.addLocalMediaStream(screenshareStream, type)
                break;
              default:
                return console.log(`unknown mediastream type: ${type}`)
                break;
            }
          } else {
            const { e, msg, length } = type === 'video' ? NAF.connection.adapter.enableCamera(true) :
              type === 'audio' ? NAF.connection.adapter.enableMicrophone(true) :
                type === 'screenshare' ? NAF.connection.adapter.enableScreenSharing(true) : null
            if (e) return
            if (!length) return console.log(`no ${type} producers now`);
          }
        } catch (e) {
          return console.log(`error occured when enabing stream...`, e);
        }

        // set the GUI
        switch (type) {
              case 'video':
                document.getElementById("indicatorvideo").classList.add("toolbarstatusindicatoron");
                break;
              case 'audio':
                document.getElementById("indicatoraudio").classList.add("toolbarstatusindicatoron");
                break;
              case 'screenshare':
                document.getElementById("indicatorscreen").classList.add("toolbarstatusindicatoron");
                break;
              default:
                break;
            }
        
        //target.textContent = `disable ${type}`


      } else {

        // set the GUI
        switch (type) {
              case 'video':
                document.getElementById("indicatorvideo").classList.remove("toolbarstatusindicatoron");
                break;
              case 'audio':
                document.getElementById("indicatoraudio").classList.remove("toolbarstatusindicatoron");
                break;
              case 'screenshare':
                document.getElementById("indicatorscreen").classList.remove("toolbarstatusindicatoron");
                break;
              default:
                break;
            }
        // disable/pause stream
        if (!stream) return console.log(`no ${type} stream yet`)


        const { e, msg, length } = type === 'video' ? NAF.connection.adapter.enableCamera(false) :
          type === 'audio' ? NAF.connection.adapter.enableMicrophone(false) :
            //type === 'screenshare' ? NAF.connection.adapter.enableScreenSharing(false) : null
            type === 'screenshare' ? NAF.connection.adapter.removeLocalMediaStream("screenshare") : null
            
            
            if(type === 'screenshare')
            {              
              screenshareStream.getTracks().forEach(function(track){
                track.stop();
              });
              screenshareStream = null;
            }
            
        
            //target.textContent = `enable ${type}`
            if (e) return
        if (!length) return console.log(`no ${type} producers now`);
         
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelector('a-scene').addEventListener('adapter-ready', ({ detail: adapter }) => {

        // disable/enable simulcast
        adapter.simulcastMode = false

        // set heartbeat interval to xx secs
        adapter.setHeartbeatTimer(30)

        // allow to control the stream
        /*videoBtn.disabled = audioBtn.disabled = shareBtn.disabled*/ /*= teachBtn.disabled*/ /*=  false;*/
      })
    })

    document.querySelector('#centralobject').addEventListener('model-error' , function() {
      console.log("model error! Please check path and coherence");

    });
    
    document.querySelector('#centralobject').addEventListener('model-loaded', function() {
      console.log('loaded');

      let cubeObject = document.querySelector('#cubelimiter').object3D;
      let centralObject = document.querySelector('#centralobject').object3D;
      let mainScene = document.querySelector('#mainscene').object3D;

      // console.log(centralObject);
      
      // measure the bounding box size of the reference cube
      let cubeBoundingBox = new THREE.Box3().setFromObject( cubeObject );
      let boxSize = new THREE.Vector3();
	    cubeBoundingBox.getSize(boxSize);
      //console.log("BoxSize.x: " + boxSize.x);
      //console.log("BoxSize.y: " + boxSize.y);
      //console.log("BoxSize.z: " + boxSize.z);

      // measure the bounding box size of the loaded object
      let centralBoundingBox = new THREE.Box3().setFromObject( centralObject );
      let centralSize = new THREE.Vector3();
	    centralBoundingBox.getSize(centralSize);
      //console.log("CentralSize.x: " + centralSize.x);
      //console.log("CentralSize.y: " + centralSize.y);
      //console.log("CentralSize.z: " + centralSize.z);

      // calculate the ratio
      var ratio = centralSize.divide(boxSize);
      //console.log("ratio.x: " + ratio.x);
      //console.log("ratio.y: " + ratio.y);
      //console.log("ratio.z: " + ratio.z);

      // choose the maxvalue ratio
      let maxRatio = ratio.x;
      
      if(ratio.y > maxRatio)
        maxRatio = ratio.y;
      if(ratio.z > maxRatio)
        maxRatio = ratio.z

      //console.log("max ratio: " + maxRatio);

      // scale the object...
      centralObject.scale.set(centralObject.scale.x * 1 / maxRatio, centralObject.scale.y * 1 / maxRatio, centralObject.scale.z * 1 / maxRatio );

      // recalculate boundingbox after resizing
      let centralBoundingBoxAfter = new THREE.Box3().setFromObject( centralObject );
      let centralSizeAfter = new THREE.Vector3();
      let centralCenter = new THREE.Vector3();
	    centralBoundingBoxAfter.getSize(centralSizeAfter);
      centralBoundingBoxAfter.getCenter(centralCenter);

      /*
      console.log("CentralBBOXAfter.x: " + centralBoundingBoxAfter.min.x);
      console.log("CentralBBOXAfter.y: " + centralBoundingBoxAfter.min.y);
      console.log("CentralBBOXAfter.z: " + centralBoundingBoxAfter.min.z);
      console.log("CentralSizeAfter.x: " + centralSizeAfter.x);
      console.log("CentralSizeAfter.y: " + centralSizeAfter.y);
      console.log("CentralSizeAfter.z: " + centralSizeAfter.z);
      console.log("BBoxCenter.x: " + centralCenter.x);
      console.log("BBoxCenter.y: " + centralCenter.y);
      console.log("BBoxCenter.z: " + centralCenter.z);
      console.log("Position.x: " + centralObject.position.x);
      console.log("Position.y: " + centralObject.position.y);
      console.log("Position.z: " + centralObject.position.z);
      */

      // reposition the object in order to show it on the central platform
      let delta = centralCenter.y - centralObject.position.y;
      //console.log("delta: " + delta);
      centralObject.position.set(centralObject.position.x,  2.55 + centralSizeAfter.y / 2 - delta, centralObject.position.z );


      //mainScene.add(new THREE.BoxHelper(centralObject));







    });

  </script>
  <script type="module">

    //import * as THREE from 'three';

    //import Stats from 'three/addons/libs/stats.module.js';

    let container, stats;
    let camera, scene, raycaster, renderer;

    let INTERSECTED;
    let theta = 0;

    const pointer = new THREE.Vector2();
    const radius = 100;

    init();
    //animate();

    function init() {
      let el = document.getElementById("head");
      camera = el.object3D;
      let sce = document.getElementById("mainscene");
      scene = sce;
      raycaster = new THREE.Raycaster();
      document.addEventListener( 'mousemove', onPointerMove );

    }


    function onPointerMove( event ) {

      pointer.x = ( event.clientX / window.innerWidth ) * 2 - 1;
      pointer.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

    }

    //


    function render() {


      // find intersections

      raycaster.setFromCamera( pointer, camera );

      const intersects = raycaster.intersectObjects( scene.children, false );

      if ( intersects.length > 0 ) {
        console.log("hey!");
        if ( INTERSECTED != intersects[ 0 ].object ) {

          if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );

          INTERSECTED = intersects[ 0 ].object;
          INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();
          INTERSECTED.material.emissive.setHex( 0xff0000 );

        }

      } else {

        if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );

        INTERSECTED = null;

      }

      renderer.render( scene, camera );

    }

  </script>
</body>

</html>